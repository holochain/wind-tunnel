{{/* The description is a 'partial' that gets passed to the `scenario_summary` template.
We could pass it as a string literal instead, but this is nicer
because your code editor's syntax highlighter can make it look more legible. */}}
{{- define "dht_sync_lag_description" }}
<p>Measure lag time between an agent publishing data and other peers being able to see it. This scenario has two roles:</p>

<ul>
    <li><b><code>write</code></b>: A simple job that just creates entries with a timestamp field. Those entries are linked to a known base hash. For each write, the metric <code>ws.custom.dht_sync_sent_count</code> is incremented.</li>
    <li><b><code>record_lag</code></b>: A job that repeatedly queries for links from the known base hash. It keeps track of records that it has seen and when a new record is found, and calculates the time difference between the timestamp of the new record and the current time. That time difference is then recorded as a custom metric called <code>wt.custom.dht_sync_lag</code>.</li>
</ul>

<p>After each behaviour loop the metric <code>ws.custom.dht_sync_recv_count</code> is incremented.</p>
{{ end -}}

{{/*
Render the use time for a DB connection pool.
Corresponding Rust type: `holochain_metrics::StandardTimingsStats`
*/}}
{{ define "dht_sync_lag_db_connection_use_time" }}
    {{ template "scenario_metric_content_item" (dict
        "name" "Use time"
        "content" (tmpl.Exec "timing_and_trend" .)
    ) }}
{{ end }}

{{/*
The pattern of a pairing of "DB utilisation" and "DB use time" metrics per database comes up quite often.
This helper creates a single metric row for both of them.
Render DB connection metrics, used primarily in `dht_sync_lag`.
Two properties:

* `utilization`: DB connection pool utilization metrics.
  Corresponding Rust type: `Option<BTreeMap<String, holochain_metrics::GaugeStats>>`
* `use_time`: DB connection use time metrics.
  Corresponding Rust type: `Option<holochain_metrics::StandardTimingsStats>`
*/}}
{{ define "dht_sync_lag_db_connection"}}
    {{ with .utilization }}
        {{ template "scenario_metric_content_item" (dict
            "name" "Utilisation"
            "content" (tmpl.Exec "min_max_mean_std" (merge (dict "unit" "%") .))
        ) }}
    {{ end }}
    {{ with .use_time }}
        {{ template "dht_sync_lag_db_connection_use_time" . }}
    {{ end }}
{{ end }}

{{/* This helper template gets used in the "WASM usage" metric line.
It's a separate template because it needs to be concatenated with other templates
into a content block that gets passed to the scenario_metric template call.
In most cases we just call `tmpl.Exec` with a metric,
but in this case we need to loop over an array of function calls,
and there's no function equivalent to `range` like there is for `template`/`tmpl.Exec`.
Corresponding Rust type: `BTreeMap<String, holochain_metrics::CounterStats>`
*/}}
{{ define "dht_sync_lag_wasm_usage_by_fn" }}
    {{ range $key, $data := . }}
        {{ template "scenario_metric_content_item" (dict
            "name" $key
            "content" (tmpl.Exec "delta" $data)
        ) }}
    {{ end }}
{{ end }}

{{/* Same situation here, for the authored DB utilisation.
We can't just use the `dht_sync_lag_db_connection` helper
because the authored DB is broken down by agent.
Corresponding Rust type: `BTreeMap<String, holochain_metrics::GaugeStats>`
*/}}
{{ define "dht_sync_lag_authored_db_utilization" }}
    {{ range $name, $value := . }}
        {{ template "scenario_metric_content_item" (dict
            "name" (print "Utilisation for " $name)
            "content" (tmpl.Exec "min_max_mean_std" (merge (dict "unit" "%") $value))
        ) }}
    {{ end }}
{{ end }}

{{/* And for countersigning agents.
Corresponding Rust Type: `BTreeMap<String, holochain_metrics::StandardTimingsStats>`
*/}}
{{ define "dht_sync_lag_countersigning_workflow_duration" }}
    {{ range $agent, $value := .}}
        {{ template "scenario_metric_content_item" (dict
            "name" $agent
            "content" (tmpl.Exec "timing_and_trend" $value)
        )}}
    {{ end }}
{{ end }}

{{/* SCENARIO START */}}

{{ template "scenario_summary" (dict
    "title" "DHT Sync Lag"
    "description" (tmpl.Exec "dht_sync_lag_description")
    "data" .run_summary
) }}

<div class="scenario-metrics">
    {{ with .scenario_metrics }}
        {{ template "scenario_metric" (dict
            "name" "Create rate"
            "description" (print `The average number of created records per agent.`)
            "content" (tmpl.Exec "rates_overall_and_per_agent" .create_rate)
        ) }}

        {{ template "scenario_metric" (dict
            "name" "Sync lag timing"
            "description" (print `The average time between when a record was created and when it is first seen by an agent.`)
            "content" (tmpl.Exec "timings_overall_and_per_agent" .sync_lag_timing)
        ) }}

        {{ template "scenario_metric" (dict
            "name" "Sync lag rate"
            "description" (print `The average number of created records discovered per agent.`)
            "content" (tmpl.Exec "rates_overall_and_per_agent" .sync_lag_rate)
        ) }}

        {{ template "scenario_metric" (dict
            "name" "Error count"
            "description" "The number of errors encountered during the scenario."
            "content" (tmpl.Exec "scalar" (dict "value" .error_count))
        ) }}

        {{ with .cascade_duration }}
            {{ template "scenario_metric" (dict
                "name" "Cascade duration"
                "description" "The time taken to execute a cascade query."
                "content" (tmpl.Exec "timing_and_trend" .)
            ) }}
        {{ end }}

        {{ if (or .wasm_usage_total .wasm_usage_by_fn) }}
            {{ template "scenario_metric" (dict
                "name" "WASM usage"
                "description" "The metered usage of a wasm ribosome."
                "content" (print
                    (default "" (and .wasm_usage_total (tmpl.Exec "scenario_metric_content_item" (dict
                        "name" "Total"
                        "content" (tmpl.Exec "delta" .wasm_usage_total)
                    ))))
                    (default "" (and .wasm_usage_by_fn (tmpl.Exec "dht_sync_lag_wasm_usage_by_fn" .wasm_usage_by_fn)))
                )
            ) }}
        {{ end }}

        {{ with .post_commit_duration }}
            {{ template "scenario_metric" (dict
                "name" "<code>post_commit</code> duration"
                "description" "The time spent executing a post commit."
                "content" (tmpl.Exec "timing_and_trend" .)
            ) }}
        {{ end }}

        {{ with .publish_dht_ops_workflow_duration }}
            {{ template "scenario_metric" (dict
                "name" "Publish DHT ops workflow duration"
                "description" "The time spent running the publish workflow."
                "content" (tmpl.Exec "timing_and_trend" .)
            ) }}
        {{ end }}

        {{ with .integrate_dht_ops_workflow_duration }}
            {{ template "scenario_metric" (dict
                "name" "Integrate DHT ops workflow duration"
                "description" "The time spent running the integration workflow."
                "content" (tmpl.Exec "timing_and_trend" .)
            ) }}
        {{ end }}

        {{ with .countersigning_workflow_duration }}
            {{ template "scenario_metric" (dict
                "name" "Countersigning workflow duration"
                "content" (tmpl.Exec "dht_sync_lag_countersigning_workflow_duration" .)
            ) }}
        {{ end }}

        {{ with .app_validation_workflow_duration }}
            {{ template "scenario_metric" (dict
                "name" "App validation workflow duration"
                "description" "The time spent running the app validation workflow."
                "content" (tmpl.Exec "timing_and_trend" .)
            ) }}
        {{ end }}

        {{ with .system_validation_workflow_duration }}
            {{ template "scenario_metric" (dict
                "name" "System validation workflow duration"
                "description" "The time spent running the sys validation workflow."
                "content" (tmpl.Exec "timing_and_trend" .)
            ) }}
        {{ end }}

        {{ with .validation_receipt_workflow_duration }}
            {{ template "scenario_metric" (dict
                "name" "Validation receipt workflow duration"
                "description" "The time spent running the validation receipt workflow."
                "content" (tmpl.Exec "timing_and_trend" .)
            ) }}
        {{ end }}

        {{ if (or .authored_db_utilization .authored_db_connection_use_time )}}
            {{ template "scenario_metric" (dict
                "name" "Authored DB"
                "description" "The utilization of connections in the authored database connection pool."
                "content" (print
                    (default "" (and .authored_db_utilization (tmpl.Exec "dht_sync_lag_authored_db_utilization" .authored_db_utilization)))
                    (default "" (and .authored_db_connection_use_time (tmpl.Exec "dht_sync_lag_db_connection_use_time" .authored_db_connection_use_time)))
                )
            ) }}
        {{ end }}

        {{ if (or .conductor_db_utilization .conductor_db_connection_use_time) }}
            {{ template "scenario_metric" (dict
                "name" "Conductor DB"
                "description" "The utilization of connections in the conductor database connection pool."
                "content" (tmpl.Exec "dht_sync_lag_db_connection" (dict
                    "utilization" .conductor_db_utilization
                    "use_time" .conductor_db_connection_use_time
                ))
            ) }}
        {{ end }}

        {{ if (or .dht_db_utilization .dht_db_connection_use_time) }}
            {{ template "scenario_metric" (dict
                "name" "DHT DB"
                "description" "The utilization of connections in the DHT database connection pool."
                "content" (tmpl.Exec "dht_sync_lag_db_connection" (dict
                    "utilization" .dht_db_utilization
                    "use_time" .dht_db_connection_use_time
                ))
            ) }}
        {{ end }}

        {{ if .p2p_request_duration }}
            {{ template "scenario_metric" (dict
                "name" "Outgoing p2p request duration"
                "description" "The time spent sending an outgoing p2p request awaiting the response"
                "content" (tmpl.Exec "timing_and_trend" .p2p_request_duration)
            ) }}
        {{ end }}

        {{ if .p2p_handle_request_duration }}
            {{ template "scenario_metric" (dict
                "name" "Incoming p2p request handling duration"
                "description" "The time spent handling an incoming p2p request"
                "content" (tmpl.Exec "timing_and_trend" .p2p_handle_request_duration)
            ) }}
        {{ end }}
    {{ end }}
</div>